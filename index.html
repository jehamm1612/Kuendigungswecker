<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>K√ºndigungswecker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem 1rem;
      margin-bottom: 1.5rem;
      align-items: end;
    }
    label {
      font-size: 0.85rem;
      font-weight: 600;
      display: block;
      margin-bottom: 0.25rem;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    button {
      padding: 0.5rem 0.9rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.danger {
      background: #dc2626;
      color: white;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;       /* horizontaler Scroll, falls zu breit */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      table-layout: fixed;
      margin: 0;  /* WICHTIG: kein extra Rand mehr */
    }

    th, td {
      padding: 0.5rem 0.4rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #6b7280;

    }
    tr.warning {
      background: #fff7ed; /* orange-ish */
    }

    tr.urgent {
      background: #fef2f2; /* red-ish */
    }
    .tag {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .tag-ok {
      background: #dcfce7;
      color: #166534;
    }
    .tag-warning {
      background: #ffedd5;
      color: #9a3412;
    }
    .tag-urgent {
      background: #fee2e2;
      color: #b91c1c;
    }
    .nowrap {
      white-space: nowrap;
    }

    .note-cell {
      max-width: 160px;       /* kannst du anpassen */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-cell {
      white-space: nowrap;
    }

    .actions-cell {
      white-space: nowrap;
    }

    th:last-child,
    td:last-child {
      padding-right: 0.4rem;   /* etwas Abstand zur rechten Kartenkante */
    }

    .actions-cell button {
      font-size: 0.8rem;
      padding: 0.3rem 0.55rem; /* schmalere Buttons */
      margin-left: 0.3rem;   /* kleiner Abstand zwischen Bearbeiten/L√∂schen */
    }

    .actions-cell button:last-child {
      margin-left: 0;  /* erster Button direkt an der Zellenkante */
    }

    .sub {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .summary {
      margin-bottom: 1rem;
      padding: 0.6rem 0.75rem;
      border-radius: 8px;
      background: #eff6ff;          /* leicht blaues Panel */
      border: 1px solid #bfdbfe;
      font-size: 0.85rem;
      color: #1e3a8a;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: baseline;
    }
    .summary-label {
      font-weight: 600;
    }
    .summary-pill {
      background: #ffffff;
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
      font-size: 0.8rem;
      font-weight: 600;
      color: #1f2933;
    }
    .footer-actions {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    @media (max-width: 600px) {
      body {
        padding: 0.75rem;
      }
      .app {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-row">
      <div>
        <h1>K√ºndigungswecker</h1>
        <div class="sub" id="todayInfo"></div>
      </div>
      <div class="filters">
        <button class="secondary" type="button" onclick="setFilter('all')">Alle</button>
        <button class="secondary" type="button" onclick="setFilter('critical')">Kritisch (&lt; 60 Tage)</button>
        <button class="secondary" type="button" onclick="setFilter('ok')">Nur OK</button>
      </div>
    </div>
    <div id="editInfo" class="sub"></div>

    <form id="contractForm">
      <div>
        <label for="name">Vertrag*</label>
        <input id="name" required placeholder="z.B. O2 Handyvertrag" />
      </div>
      <div>
        <label for="provider">Anbieter</label>
        <input id="provider" placeholder="z.B. O2, Vodafone, Bahn" />
      </div>
      <div>
        <label for="endDate">Vertragsende*</label>
        <input id="endDate" type="date" required />
      </div>
      <div>
        <label for="noticeMonths">K√ºndigungsfrist (Monate)</label>
        <input id="noticeMonths" type="number" min="0" value="3" />
      </div>
      <div>
        <label for="monthlyCost">Kosten / Monat (‚Ç¨)</label>
        <input id="monthlyCost" type="number" min="0" step="0.01" />
      </div>
      <div>
        <label for="note">Notiz</label>
        <input id="note" placeholder="z.B. Kundennummer, Login, Besonderheiten" />
      </div>
      <div>
        <button id="submitBtn" type="submit" class="primary">Vertrag hinzuf√ºgen</button>
      </div>

    </form>

    <div id="summaryInfo" class="sub summary"></div>

    <div class="footer-actions">
      <button type="button" class="secondary" onclick="exportContracts()">
        Backup herunterladen
      </button>
      <button type="button" class="secondary" onclick="document.getElementById('importInput').click()">
        Backup importieren
      </button>
      <input
        id="importInput"
        type="file"
        accept="application/json"
        style="display:none"
        onchange="importContracts(event)"
       />
     </div>

<div class="table-container">
  <table>
       <thead>
        <tr>
          <th>Vertrag</th>
          <th>Anbieter</th>
          <th>Vertragsende</th>
          <th class="nowrap">K√ºndigen bis</th>
          <th class="nowrap">Tage bis Frist</th>
          <th>Monatlich</th>
          <th>Status</th>
          <th>Notiz</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody id="contractTableBody">
      </tbody>
    </table>
   </div>
  </div>

   <script>
    const STORAGE_KEY = "kuendigungswecker_contracts_v1";
    let contracts = [];
    let currentFilter = "all";
    let editingId = null;
    let submitBtn = null;
    let editInfoEl = null;
    let summaryEl = null;

    function formatDate(date) {
      if (!date) return "";
      const d = new Date(date);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleDateString("de-DE");
    }

    function daysBetween(a, b) {
      const ms = b - a;
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    }

    function subtractMonths(date, months) {
      const d = new Date(date);
      const day = d.getDate();
      const newMonth = d.getMonth() - months;
      const res = new Date(d);
      res.setMonth(newMonth);
      if (res.getDate() !== day) {
        // Monatsende-Fall (z. B. 31. auf 30. oder 28./29.)
        res.setDate(0);
      }
      return res;
    }

    function loadContracts() {
      const raw = localStorage.getItem(STORAGE_KEY);
      contracts = raw ? JSON.parse(raw) : [];
    }

    function saveContracts() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(contracts));
    }

    function addContract(contract) {
      contracts.push(contract);
      saveContracts();
      renderTable();
    }

    function deleteContract(id) {
      if (!confirm("Diesen Vertrag wirklich l√∂schen?")) return;
      contracts = contracts.filter(c => c.id !== id);
      saveContracts();
      renderTable();
      if (editingId === id) {
        exitEditMode();
      }
    }

    function setFilter(filter) {
      currentFilter = filter;
      renderTable();
    }

    function classifyStatus(cancelDate) {
      const today = new Date();
      const diff = daysBetween(today, cancelDate);
      if (diff < 0) {
        return { label: "Frist verpasst", type: "urgent", days: diff };
      } else if (diff <= 14) {
        return { label: "Sehr dringend", type: "urgent", days: diff };
      } else if (diff <= 60) {
        return { label: "Bald", type: "warning", days: diff };
      } else {
        return { label: "OK", type: "ok", days: diff };
      }
    }

    function renderTable() {
      const tbody = document.getElementById("contractTableBody");
      tbody.innerHTML = "";

      // --- Zusammenfassung berechnen (√ºber alle Vertr√§ge) ---
      let totalMonthly = 0;
      let criticalMonthly = 0;
      let countAll = contracts.length;
      let countCritical = 0;

      contracts.forEach(c => {
        const endDate = new Date(c.endDate);
        if (Number.isNaN(endDate)) return;
        const noticeMonths = Number(c.noticeMonths || 0);
        const cancelDate = subtractMonths(endDate, noticeMonths);
        const status = classifyStatus(cancelDate);
        if (c.monthlyCost != null) {
          totalMonthly += Number(c.monthlyCost);
          if (status.days <= 60) {
            criticalMonthly += Number(c.monthlyCost);
            countCritical++;
          }
        }
      });

       if (summaryEl) {
        if (countAll === 0) {
          summaryEl.textContent = "Noch keine Vertr√§ge angelegt.";
        } else {
          let html = `üîî <span class="summary-label">√úberblick:</span>`;
          html += ` <span class="summary-pill">Vertr√§ge: ${countAll}</span>`;
          if (totalMonthly > 0) {
            html += ` <span class="summary-pill">‚àë monatlich: ${totalMonthly.toFixed(2)} ‚Ç¨</span>`;
            if (criticalMonthly > 0) {
              html += ` <span class="summary-pill">kritisch (&le;60 Tage): ${criticalMonthly.toFixed(2)} ‚Ç¨</span>`;
            }
          }
          summaryEl.innerHTML = html;
        }
      }


      // --- Tabelle (mit Filter) rendern ---
      const filtered = contracts.filter(c => {
        const endDate = new Date(c.endDate);
        const noticeMonths = Number(c.noticeMonths || 0);
        const cancelDate = subtractMonths(endDate, noticeMonths);
        const status = classifyStatus(cancelDate);

        if (currentFilter === "critical") {
          return status.days <= 60;
        } else if (currentFilter === "ok") {
          return status.type === "ok";
        }
        return true;
      });

      filtered
        .sort((a, b) => new Date(a.endDate) - new Date(b.endDate))
        .forEach(contract => {
          const tr = document.createElement("tr");

          const endDate = new Date(contract.endDate);
          const noticeMonths = Number(contract.noticeMonths || 0);
          const cancelDate = subtractMonths(endDate, noticeMonths);
          const status = classifyStatus(cancelDate);
          const daysLeft = status.days;

          if (status.type === "urgent") tr.classList.add("urgent");
          else if (status.type === "warning") tr.classList.add("warning");

          tr.innerHTML = `
            <td>${contract.name}</td>
            <td>${contract.provider || ""}</td>
            <td>${formatDate(contract.endDate)}</td>
            <td>${formatDate(cancelDate)}</td>
            <td>${daysLeft}</td>
            <td>${contract.monthlyCost != null ? contract.monthlyCost.toFixed(2) + " ‚Ç¨" : ""}</td>
            <td class="status-cell">
              <span class="tag tag-${status.type}">
                ${status.label}
              </span>
            </td>
            <td class="note-cell">${contract.note ? contract.note : ""}</td>
            <td class="actions-cell">
              <button class="secondary" type="button" onclick="startEditContract('${contract.id}')">
                Bearbeiten
              </button>
              <button class="danger" type="button" onclick="deleteContract('${contract.id}')">
                L√∂schen
              </button>
            </td>
          `;

          tbody.appendChild(tr);
        });
    }

    function exitEditMode() {
      editingId = null;
      if (editInfoEl) {
        editInfoEl.textContent = "";
      }
      if (submitBtn) {
        submitBtn.textContent = "Vertrag hinzuf√ºgen";
      }
    }

    function startEditContract(id) {
      const contract = contracts.find(c => c.id === id);
      if (!contract) return;

      editingId = id;
      document.getElementById("name").value = contract.name || "";
      document.getElementById("provider").value = contract.provider || "";
      document.getElementById("endDate").value = contract.endDate || "";
      document.getElementById("noticeMonths").value = contract.noticeMonths != null ? contract.noticeMonths : 0;
      document.getElementById("monthlyCost").value = contract.monthlyCost != null ? contract.monthlyCost : "";
      document.getElementById("note").value = contract.note || "";

      if (submitBtn) {
        submitBtn.textContent = "√Ñnderungen speichern";
      }
      if (editInfoEl) {
        editInfoEl.textContent = "Bearbeite: " + contract.name;
      }

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function initForm() {
      const form = document.getElementById("contractForm");
      submitBtn = document.getElementById("submitBtn");
      editInfoEl = document.getElementById("editInfo");
      summaryEl = document.getElementById("summaryInfo");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("name").value.trim();
        const provider = document.getElementById("provider").value.trim();
        const endDate = document.getElementById("endDate").value;
        const noticeMonths = Number(document.getElementById("noticeMonths").value || 0);
        const monthlyCostRaw = document.getElementById("monthlyCost").value;
        const monthlyCost = monthlyCostRaw ? Number(monthlyCostRaw) : null;
        const note = document.getElementById("note").value.trim();

        if (!name || !endDate) {
          alert("Bitte mindestens Vertrag und Vertragsende ausf√ºllen.");
          return;
        }

        if (editingId) {
          const idx = contracts.findIndex(c => c.id === editingId);
          if (idx !== -1) {
            contracts[idx].name = name;
            contracts[idx].provider = provider;
            contracts[idx].endDate = endDate;
            contracts[idx].noticeMonths = noticeMonths;
            contracts[idx].monthlyCost = monthlyCost;
            contracts[idx].note = note;
            saveContracts();
            renderTable();
          }
          form.reset();
          document.getElementById("noticeMonths").value = 3;
          exitEditMode();
        } else {
          const contract = {
            id: "c_" + Date.now() + "_" + Math.random().toString(16).slice(2),
            name,
            provider,
            endDate,
            noticeMonths,
            monthlyCost,
            note,
            createdAt: new Date().toISOString()
          };

          addContract(contract);
          form.reset();
          document.getElementById("noticeMonths").value = 3;
        }
      });
    }

    function exportContracts() {
      if (!contracts || contracts.length === 0) {
        if (!confirm("Es sind keine Vertr√§ge gespeichert. Trotzdem eine (leere) Backup-Datei herunterladen?")) {
          return;
        }
      }
      const dataStr = JSON.stringify(contracts, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
      a.href = url;
      a.download = "kuendigungswecker_backup_" + today + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importContracts(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const data = JSON.parse(text);

          if (!Array.isArray(data)) {
            alert("Ung√ºltiges Backup-Format (keine Liste).");
            return;
          }

          if (!confirm("Bestehende Vertr√§ge mit diesem Backup ersetzen?")) {
            return;
          }

          contracts = data;
          saveContracts();
          renderTable();
          alert("Backup erfolgreich importiert.");
        } catch (err) {
          console.error(err);
          alert("Fehler beim Einlesen des Backups: " + err.message);
        } finally {
          // zur√ºcksetzen, damit man dieselbe Datei sp√§ter nochmal w√§hlen kann
          event.target.value = "";
        }
      };
      reader.readAsText(file);
    }


    function initTodayInfo() {
      const el = document.getElementById("todayInfo");
      const today = new Date();
      el.textContent = "Heute ist " + today.toLocaleDateString("de-DE") +
        " ‚Äì Fristen im Blick behalten und sp√§teren Stress vermeiden.";
    }

    // Init
    loadContracts();
    initForm();
    initTodayInfo();
    renderTable();
  </script>


</body>
</html>
